#!/bin/bash

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root or using sudo."
  exit 1
fi

# Set user variable
user=$(ls /home)

# Set timezone
timedatectl set-timezone Australia/Sydney

# Update package lists
echo "***Updating packages***"
apt update

# Upgrade packages
echo "***Installing updates***"
apt full-upgrade -y

# Install required packages
echo "***Installing additional packages***"
apt install linux-headers-amd64 terminator bloodhound realtek-rtl88xxau-dkms xrdp exim4 -y

# Remove packages that are no longer required
echo "***Removing packages that are no longer required***"
apt autoremove -y

# Configure SSH
echo "***Configuring SSH access***"

# Create the directory and import public key
mkdir /home/$user/.ssh
curl https://raw.githubusercontent.com/DaneSerpente/Pentesting/main/Build_Scripts/Files/pentest_rsa.pub > /home/$user/.ssh/authorized_keys

# Find pubkey and password lines in SSH config and configure key-based auth only
pkauth=$(grep -n -m 1 "PubkeyAuthentication" "/etc/ssh/sshd_config" | awk -F: '{print $1}')
passauth=$(grep -n -m 1 "PasswordAuthentication" "/etc/ssh/sshd_config" | awk -F: '{print $1}')
sed -i "${pkauth}s/.*/PubkeyAuthentication yes/" "/etc/ssh/sshd_config"
sed -i "${passauth}s/.*/PasswordAuthentication no/" "/etc/ssh/sshd_config"

# Enable and start SSH server
systemctl enable ssh
systemctl start ssh

# Configure XRDP
echo "***Configuring XRDP Access***"
xrdp_port=$(grep -n -m 1 "^port=" /etc/xrdp/xrdp.ini | awk -F: '{print $1}')
sed -i "${xrdp_port}s/.*/port=tcp:\/\/.:3390/" "/etc/xrdp/xrdp.ini"
systemctl enable xrdp
systemctl start xrdp

# Configure OpenVPN for always-on connection
systemctl enable openvpn@osc_azure
cat <<EOF > /etc/systemd/system/openvpn@osc_azure.service.d/override.conf
[Service]
Restart=on-failure
RestartSec=5s
EOF
systemctl daemon-reload

# Add ZSH customisation
curl https://raw.githubusercontent.com/DaneSerpente/Pentesting/main/Build_Scripts/Files/zshrc > /home/$user/.zshrc
curl https://raw.githubusercontent.com/DaneSerpente/Pentesting/main/Build_Scripts/Files/zshrc > /root/.zshrc

# Install Nessus
echo "***Installing Nessus***"
curl "https://www.tenable.com/downloads/api/v2/pages/nessus/files/Nessus-latest-debian10_amd64.deb" --output /tmp/nessus.deb
dpkg -i /tmp/nessus.deb

# Clone GitHub Repos
echo "***Cloning GitHub Repositories***"
git clone https://github.com/D3Ext/WEF.git /opt/github/WEF
git clone https://github.com/derv82/wifite2.git /opt/github/wifite2